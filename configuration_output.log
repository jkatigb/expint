INFO: --- Starting Configuration Phase (Ansible) ---

PLAY [Configure all nodes] *****************************************************

TASK [Gathering Facts] *********************************************************
ok: [lb]
ok: [web1]
ok: [mon]
ok: [web2]

TASK [common : Ensure expensify user exists and is in the sudo group] **********
changed: [mon]
changed: [web1]
changed: [lb]
changed: [web2]

TASK [common : Add expensify's SSH key as authorized_key] **********************
changed: [lb]
changed: [web2]
changed: [web1]
changed: [mon]

TASK [common : Allow 'expensify' user to run sudo without a password] **********
changed: [lb]
changed: [web1]
changed: [mon]
changed: [web2]

PLAY [Build web tier] **********************************************************

TASK [Gathering Facts] *********************************************************
ok: [web2]
ok: [web1]

TASK [webserver : Install Nginx] ***********************************************
changed: [web1]
changed: [web2]

TASK [webserver : Deploy main Nginx configuration] *****************************
changed: [web1]
changed: [web2]

TASK [webserver : Deploy website virtual host configuration] *******************
changed: [web1]
changed: [web2]

TASK [webserver : Ensure default site is enabled] ******************************
ok: [web1]
ok: [web2]

TASK [webserver : Deploy basic index page] *************************************
changed: [web1]
changed: [web2]

TASK [webserver : Ensure Nginx is running] *************************************
ok: [web1]
ok: [web2]

RUNNING HANDLER [webserver : Reload nginx] *************************************
changed: [web2]
changed: [web1]

PLAY [Build load balancer] *****************************************************

TASK [Gathering Facts] *********************************************************
ok: [lb]

TASK [loadbalancer : Install HAProxy] ******************************************
changed: [lb]

TASK [loadbalancer : Deploy HAProxy cfg] ***************************************
changed: [lb]

TASK [loadbalancer : Ensure HAProxy is running] ********************************
ok: [lb]

RUNNING HANDLER [loadbalancer : Restart haproxy] *******************************
changed: [lb]

PLAY [Build monitoring server] *************************************************

TASK [Gathering Facts] *********************************************************
ok: [mon]

TASK [monitoring : Install Nagios Core + plugins + dependencies] ***************
changed: [mon] => (item=nagios4)
ok: [mon] => (item=nagios-plugins)
changed: [mon] => (item=python3-pip)
ok: [mon] => (item=python3)

TASK [monitoring : Make sure /usr/local/nagios/libexec/ exists] ****************
changed: [mon]

TASK [monitoring : Copy over custom plugin] ************************************
changed: [mon]

TASK [monitoring : Copy over web_cluster.json] *********************************
changed: [mon]

TASK [monitoring : Deploy host + cluster configs] ******************************
changed: [mon] => (item={'src': 'hosts.cfg.j2', 'dest': 'hosts.cfg'})
changed: [mon] => (item={'src': 'web_cluster.cfg.j2', 'dest': 'web_cluster.cfg'})

TASK [monitoring : Ensure Nagios is running] ***********************************
ok: [mon]

RUNNING HANDLER [monitoring : Restart nagios] **********************************
changed: [mon]

PLAY [Secure environment] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [mon]
ok: [lb]
ok: [web2]
ok: [web1]

TASK [security : UFW reset to defaults] ****************************************
changed: [lb]
changed: [web1]
changed: [mon]
changed: [web2]

TASK [security : UFW default-deny and enable] **********************************
ok: [lb]
ok: [mon]
ok: [web1]
ok: [web2]

TASK [security : UFW public ssh for loadbalancer] ******************************
skipping: [web1] => (item=22) 
skipping: [web1] => (item=80) 
skipping: [web1] => (item=60000:65000) 
skipping: [web1]
skipping: [web2] => (item=22) 
skipping: [web2] => (item=80) 
skipping: [web2] => (item=60000:65000) 
skipping: [web2]
skipping: [mon] => (item=22) 
skipping: [mon] => (item=80) 
skipping: [mon] => (item=60000:65000) 
skipping: [mon]
changed: [lb] => (item=22)
changed: [lb] => (item=80)
changed: [lb] => (item=60000:65000)

TASK [security : UFW ssh access from loadbalancer to internal hosts] ***********
skipping: [lb] => (item=22) 
skipping: [lb] => (item=80) 
skipping: [lb]
changed: [web1] => (item=22)
changed: [mon] => (item=22)
changed: [web2] => (item=22)
changed: [web1] => (item=80)
changed: [mon] => (item=80)
changed: [web2] => (item=80)

TASK [security : UFW allow HTTP from monitoring server to webservers] **********
skipping: [lb]
skipping: [mon]
changed: [web1]
changed: [web2]

TASK [security : UFW enable internal group] ************************************
skipping: [lb]
changed: [web2]
changed: [web1]
changed: [mon]

TASK [security : UFW enable loadbalancer group] ********************************
skipping: [web1]
skipping: [web2]
skipping: [mon]
changed: [lb]

TASK [security : Harden SSH] ***************************************************
changed: [web1]
changed: [lb]
changed: [web2]
changed: [mon]

RUNNING HANDLER [security : Restart ssh] ***************************************
changed: [lb]
changed: [web1]
changed: [mon]
changed: [web2]

PLAY RECAP *********************************************************************
lb                         : ok=16   changed=11   unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   
mon                        : ok=19   changed=14   unreachable=0    failed=0    skipped=3    rescued=0    ignored=0   
web1                       : ok=20   changed=14   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   
web2                       : ok=20   changed=14   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   

INFO: --- Configuration Phase Complete ---
