# Automated Infrastructure and Monitoring Setup

This project automates the deployment of a web cluster infrastructure using Terraform and configures a Nagios-based monitoring stack on it using Ansible. The entire process is managed by the `deploy_and_test.sh` script.

## Prerequisites

- **Terraform:** [Install Terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli)
- **Ansible:** [Install Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html) (version 2.9+ recommended)
- **Python 3.x:** On your control machine (usually comes with Ansible)
- **Cloud Provider Account:** Credentials configured for Terraform to provision resources (e.g., DigitalOcean API token).
- **SSH Key Pair:** An SSH key pair. The public key might be referenced in Terraform configurations to be installed on the VMs.

## Project Structure

- **`deploy_and_test.sh`**: The main script to manage the deployment, testing, and destruction of the environment.
- **`terraform/do/`**: Contains Terraform configurations for provisioning infrastructure on DigitalOcean.
    - **`environments/test.tfvars`**: Terraform variables file for the test environment. You may need to customize this, especially for provider credentials or specific naming.
- **`ansible/`**: Contains Ansible playbooks and roles for configuration management.
    - **`site.yml`**: The main Ansible playbook that orchestrates the configuration.
    - **`inventory.ini`**: **Automatically generated by Terraform** during the `--provision` step. Do not edit this manually if using the script.
    - **`ansible.cfg`**: Ansible configuration file (e.g., to disable host key checking).
    - **`roles/`**: Contains Ansible roles for modular configuration (e.g., `common`, `webserver`, `nagios_server`, `nagios_client`, `security`).
    - **`tests/`**: Contains Ansible playbooks used for testing the deployed configuration.

## Automated Workflow with `deploy_and_test.sh`

The `deploy_and_test.sh` script is the primary interface for managing the environment.

**Usage:**

```bash
./deploy_and_test.sh [action1] [action2] ...
```

**Available Actions:**

-   `--provision`:
    1.  Initializes Terraform (`terraform init`).
    2.  Provisions infrastructure using Terraform (`terraform apply`), typically using variables from `terraform/do/environments/test.tfvars`.
    3.  Generates the Ansible inventory file (`ansible/inventory.ini`) from Terraform outputs.
-   `--configure`:
    1.  Runs the main Ansible playbook (`ansible/site.yml`) to configure the servers defined in `ansible/inventory.ini`.
    2.  Requires the inventory file to exist (usually created by a `--provision` step).
-   `--test`:
    1.  Runs a series of test Ansible playbooks (defined in the script, located in `ansible/tests/`) against the deployed and configured infrastructure.
    2.  Requires the environment to be provisioned and preferably configured.
-   `--destroy`:
    1.  Tears down the infrastructure provisioned by Terraform (`terraform destroy`).

**Examples:**

-   Provision the infrastructure:
    ```bash
    ./deploy_and_test.sh --provision
    ```
-   Configure already provisioned infrastructure:
    ```bash
    ./deploy_and_test.sh --configure
    ```
-   Provision and then configure:
    ```bash
    ./deploy_and_test.sh --provision --configure
    ```
-   Provision, configure, and then run tests:
    ```bash
    ./deploy_and_test.sh --provision --configure --test
    ```
-   Run tests on an already provisioned and configured environment:
    ```bash
    ./deploy_and_test.sh --test
    ```
-   Provision, configure, test, and then destroy:
    ```bash
    ./deploy_and_test.sh --provision --configure --test --destroy
    ```
-   Destroy the environment:
    ```bash
    ./deploy_and_test.sh --destroy
    ```

**Key Script Configuration Variables (at the top of `deploy_and_test.sh`):**

-   `TERRAFORM_DIR`: Path to the Terraform configuration directory.
-   `ANSIBLE_DIR`: Path to the Ansible configuration directory.
-   `TF_VARS_FILE`: Path to the Terraform variables file (relative to `TERRAFORM_DIR`).
-   `INVENTORY_FILE`: Path where the Ansible inventory will be generated.
-   `ANSIBLE_PLAYBOOK`: Path to the main Ansible site playbook.
-   `TEST_PLAYBOOKS`: An array of test playbook names (located in `ANSIBLE_DIR/tests/`).

## Infrastructure Provisioning (Terraform)

-   Infrastructure is defined in `.tf` files within the `terraform/do/` directory.
-   Provider credentials and environment-specific variables (like region, image names, droplet sizes) should be managed via the `terraform/do/environments/test.tfvars` file or through environment variables recognized by your Terraform provider (e.g., `DIGITALOCEAN_TOKEN`).
-   Terraform generates the `ansible/inventory.ini` file during the `--provision` step, which Ansible uses to know which hosts to configure.

## Configuration Management (Ansible)

-   Ansible is used to configure the servers provisioned by Terraform.
-   The main playbook is `ansible/site.yml`, typically run via the `--configure` flag in the script.
-   Configurations are organized into roles within `ansible/roles/` for better maintainability. Common roles might include:
    -   `common`: Base configurations for all servers.
    -   `webserver`: Setup and configuration of web servers.
    -   `loadbalancer`: Setup of a load balancer.
    -   `monitoring`: Setup of the Nagios monitoring server.
    -   `security`: Firewall rules (e.g., UFW) and other security hardening.
-   Ansible settings like `remote_user` and SSH arguments (e.g. for host key checking) are managed in `ansible/ansible.cfg` or passed directly in the `deploy_and_test.sh` script.
-   Test playbooks in `ansible/tests/` are used to verify the configuration (run via `--test`).

## Manual Steps (If Not Using the Script)

While the `deploy_and_test.sh` script automates the process, understanding the manual steps can be helpful for debugging:

1.  **Terraform Provisioning (`--provision` equivalent):**
    ```bash
    cd terraform/do
    terraform init
    terraform apply -var-file="environments/test.tfvars" -auto-approve
    terraform output -raw inventory_ini > ../../ansible/inventory.ini
    cd ../..
    ```
2.  **Ansible Configuration (`--configure` equivalent):**
    ```bash
    cd ansible
    ansible-playbook -i inventory.ini site.yml --ssh-extra-args='-o StrictHostKeyChecking=no'
    # To run a specific test (`--test` equivalent for one playbook):
    # ansible-playbook -i inventory.ini tests/your_test_playbook.yml --ssh-extra-args='-o StrictHostKeyChecking=no'
    cd ..
    ```
3.  **Terraform Teardown (`--destroy` equivalent):**
    ```bash
    cd terraform/do
    terraform destroy -var-file="environments/test.tfvars" -auto-approve
    cd ../..
    ```

## Group Variables Example

Variables applicable to all hosts can be defined in `ansible/group_vars/all.yml`. For example:

```yaml
# ansible/group_vars/all.yml
admin_user: "ubuntu" # Default SSH user for Ansible connections
# Define other common variables here
```

